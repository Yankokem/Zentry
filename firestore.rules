rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can read any user document (for team member info, project creators, etc.)
    // But can only write their own user documents
    // Allow list queries for checking user existence by email (needed for login/signup)
    match /users/{userId} {
      allow read: if request.auth != null;  // Allow reading any user's public info
      allow write: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null;
      allow list: if request.auth != null;  // Allow querying users collection
    }

    // Wishlist items
    match /wishlists/{wishId} {
      // Allow getting a single document if user owns it or it's shared with them
      allow get: if request.auth != null &&
        (resource.data.userId == request.auth.uid ||
         request.auth.token.email in resource.data.get('sharedWith', []));
      
      // Allow listing if query filters by userId matching auth token
      allow list: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        request.auth.token.email in resource.data.get('sharedWith', [])
      );

      allow write: if request.auth != null &&
        (resource.data.userId == request.auth.uid ||
         request.auth.token.email in resource.data.get('sharedWith', []));
      allow create: if request.auth != null;
    }

    // Categories
    match /wishlist_categories/{categoryId} {
      allow read: if request.auth != null;
      allow write, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null;
    }

    // Journal entries
    match /journal_entries/{entryId} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null;
    }

    // Projects
    match /projects/{projectId} {
      allow read, write: if request.auth != null &&
        (resource.data.userId == request.auth.uid ||
         request.auth.token.email in resource.data.get('teamMembers', []));
      allow create: if request.auth != null;
      
      // Tickets subcollection
      match /tickets/{ticketId} {
        // Use separate rule for list to ensure parent project check works
        allow list: if request.auth != null && (
          get(/databases/$(database)/documents/projects/$(projectId)).data.userId == request.auth.uid ||
          request.auth.token.email in get(/databases/$(database)/documents/projects/$(projectId)).data.get('teamMembers', [])
        );
        allow get: if request.auth != null && (
          get(/databases/$(database)/documents/projects/$(projectId)).data.userId == request.auth.uid ||
          request.auth.token.email in get(/databases/$(database)/documents/projects/$(projectId)).data.get('teamMembers', [])
        );
        allow write, delete: if request.auth != null && (
          get(/databases/$(database)/documents/projects/$(projectId)).data.userId == request.auth.uid ||
          request.auth.token.email in get(/databases/$(database)/documents/projects/$(projectId)).data.get('teamMembers', [])
        );
        allow create: if request.auth != null;
      }
    }

    // Bug reports - users can read/write their own
    match /bug_reports/{reportId} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null;
    }

    // Notifications - users can read their own notifications in subcollection
    // Structure: notifications/users/{userId}/notifications/{notificationId}
    match /notifications/users/{userId}/{document=**} {
      allow read, write, delete: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null;
    }

    // Moods - users can read/write their own moods
    match /moods/{moodId} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null;
      allow list: if request.auth != null;  // Allow querying moods by userId
    }

    // Admin collection - Only accessible by the admin user
    // This allows the admin initialization to work on app startup
    match /admins/{adminId} {
      allow read, write: if request.auth != null && 
        request.auth.token.email == 'zentry_admin@zentry.app.com';
    }

    // Admin-related collections - only accessible by verified admin users
    match /bug_reports/{reportId} {
      allow read: if request.auth != null && 
        (resource.data.userId == request.auth.uid || 
         request.auth.token.email == 'zentry_admin@zentry.app.com');
      allow write: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null;
      allow delete: if request.auth != null && 
        request.auth.token.email == 'zentry_admin@zentry.app.com';
    }
  }
}
