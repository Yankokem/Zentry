rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Check if the user has the 'admin' role in their user profile
    // Uses exists() check to prevent rule evaluation errors if user doc missing
    function hasAdminRole() {
      return request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('role', 'member') == 'admin';
    }

    // Check if the user is the hardcoded system admin (fallback)
    // Uses .get('email', '') to safely access email even if missing from token
    function isSystemAdmin() {
      return request.auth != null && 
        request.auth.token.get('email', '') == 'zentry_admin@zentry.app.com';
    }

    // Combined admin check
    function isAdmin() {
      return isSystemAdmin() || hasAdminRole();
    }

    // Helper to safely get user email from token OR database
    function getUserEmail() {
      return request.auth.token.get('email', '') != '' ? 
             request.auth.token.get('email', '') : 
             (exists(/databases/$(database)/documents/users/$(request.auth.uid)) ? 
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('email', '') : '');
    }

    // Helper to check project access
    // Safely accesses email and checks project existence first
    function canAccessProject(projectId) {
      let projectPath = /databases/$(database)/documents/projects/$(projectId);
      let userEmail = getUserEmail();
      
      return request.auth != null && 
             exists(projectPath) && (
               get(projectPath).data.userId == request.auth.uid ||
               (userEmail != '' && 
                userEmail in get(projectPath).data.get('teamMembers', []))
             );
    }

    // User Metadata - admin only for management
    match /user_metadata/{userId} {
      allow read: if isAdmin() || (request.auth != null && request.auth.uid == userId);
      allow write: if isAdmin();
      allow create: if request.auth != null;
    }

    // Users collection
    match /users/{userId} {
      allow read: if request.auth != null; 
      allow write: if isAdmin() || (request.auth != null && request.auth.uid == userId);
      allow list: if request.auth != null;
      allow create: if request.auth != null;
    }

    // Wishlist items
    match /wishlists/{wishId} {
      allow get: if isAdmin() || (
        request.auth != null && (
          resource.data.userId == request.auth.uid ||
          request.auth.token.get('email', '') in resource.data.get('sharedWith', [])
        )
      );
      
      allow list: if isAdmin() || (
        request.auth != null && (
          resource.data.userId == request.auth.uid ||
          request.auth.token.get('email', '') in resource.data.get('sharedWith', [])
        )
      );

      allow write: if isAdmin() || (
        request.auth != null && (
          resource.data.userId == request.auth.uid ||
          request.auth.token.get('email', '') in resource.data.get('sharedWith', [])
        )
      );
      allow create: if request.auth != null;
    }

    // Categories
    match /wishlist_categories/{categoryId} {
      allow read: if request.auth != null;
      allow write, delete: if isAdmin() || (request.auth != null && resource.data.userId == request.auth.uid);
      allow create: if request.auth != null;
    }

    // Journal entries
    match /journal_entries/{entryId} {
      allow read, write: if isAdmin() || (request.auth != null && resource.data.userId == request.auth.uid);
      allow create: if request.auth != null;
    }

    // Projects
    match /projects/{projectId} {
      allow read, write: if isAdmin() || (
        request.auth != null && (
          resource.data.userId == request.auth.uid ||
          (getUserEmail() != '' && 
           getUserEmail() in resource.data.get('teamMembers', []))
        )
      );
      allow create: if request.auth != null;
      
      // Tickets subcollection
      match /tickets/{ticketId} {
        allow list: if isAdmin() || canAccessProject(projectId);
        allow get: if isAdmin() || canAccessProject(projectId);
        allow write, delete: if isAdmin() || canAccessProject(projectId);
        allow create: if request.auth != null;
      }
    }

    // Bug reports
    match /bug_reports/{reportId} {
      allow read, list: if isAdmin() || (request.auth != null && resource.data.userId == request.auth.uid);
      allow write: if isAdmin() || (request.auth != null && resource.data.userId == request.auth.uid);
      allow create: if request.auth != null;
    }

    // Notifications
    match /notifications/users/{userId}/{document=**} {
      allow read, write, delete: if isAdmin() || (request.auth != null && request.auth.uid == userId);
      allow create: if request.auth != null;
    }

    // Moods
    match /moods/{moodId} {
      allow read, write: if isAdmin() || (request.auth != null && resource.data.userId == request.auth.uid);
      allow create: if request.auth != null;
      allow list: if request.auth != null;
    }

    // Admin collection - Only accessible by the system admin email user
    match /admins/{adminId} {
      allow read, write: if isSystemAdmin();
    }

    // Account Appeals - Users can create appeals, admins can read and manage
    match /account_appeal/{appealId} {
      // Allow any authenticated user to write (create/update) appeals
      allow write, create: if request.auth != null;
      
      // Allow read and list access
      allow read, list: if request.auth != null;
      
      // Admins can delete appeals
      allow delete: if isAdmin();
    }

    // Default fallback rules - Don't apply to account_appeal (has its own rules)
    match /{document=**} {
      allow read: if isAdmin() || (
        request.auth != null && 
        (request.resource == null || 
         request.resource.data.userId == request.auth.uid)
      );
      allow write: if isAdmin() || (
        request.auth != null && 
        request.resource.data.userId == request.auth.uid
      );
    }
  }
}
